<div class="expandable-grid">
  {% for block in section.blocks %}
    <div class="grid-category collapsed" {{ block.shopify_attributes }}>
      <div class="category-header">
        <h3 class="category-title">{{ block.settings.title }}</h3>
        <button class="toggle-button" aria-expanded="false">
          <span class="icon-minus">−</span>
          <span class="icon-plus">+</span>
        </button>
      </div>
      <div class="grid-items" style="grid-template-columns: repeat({{ section.settings.columns }}, 1fr); gap: {{ section.settings.gap }}px;">
        {% for i in (1..block.settings.item_count) %}
          {% assign image_key = 'image_' | append: i %}
          {% assign title_key = 'title_' | append: i %}
          {% assign text_key = 'text_' | append: i %}
          
          <div class="grid-item">
            {% if block.settings[image_key] != blank %}
              <div class="grid-image">
                {{ block.settings[image_key] | image_url: width: 300 | image_tag }}
              </div>
            {% endif %}
            <h4 class="item-title">{{ block.settings[title_key] }}</h4>
            <div class="item-text">{{ block.settings[text_key] }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<style>
  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  .toggle-button {
    background: none;
    border: none;
    font-size: inherit;
    padding: 0 15px;
    height: 100%;
    display: flex;
    align-items: center;
  }
  .toggle-button span {
    font-size: {{ section.settings.title_size }}px;
    font-weight: {{ section.settings.title_weight }};
    line-height: 1;
  }
  .icon-minus {
    display: none;
  }
  .collapsed .icon-minus {
    display: inline;
  }
  .collapsed .icon-plus {
    display: none;
  }
  .grid-items {
    transition: max-height 0.3s ease, opacity 0.2s ease;
    overflow: hidden;
    max-height: 2000px; /* 足够大的初始值 */
    opacity: 1;
  }
  .grid-category.collapsed .grid-items {
    max-height: 0 !important;
    opacity: 0;
    margin-top: 0;
    margin-bottom: 0;
    padding-top: 0;
    padding-bottom: 0;
    border: none;
  }
  .expandable-grid {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  .grid-category {
    margin-bottom: 30px;
  }
  .grid-items {
    display: grid;
    margin-top: 15px;
  }
  .grid-item {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .grid-image {
    position: relative;
    padding-top: 100%;
    overflow: hidden;
  }
  .grid-image img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .item-title {
    padding: 10px 15px;
    margin: 0;
    font-size: {{ section.settings.title_size }}px;
    font-weight: {{ section.settings.title_weight }};
  }
  .item-text {
    padding: 0 15px 15px;
  }
</style>

<script>
(function() {
  function initAccordions() {
    const headers = document.querySelectorAll('.category-header');
    
    headers.forEach(header => {
      // 确保只绑定一次事件
      header.removeEventListener('click', toggleAccordion);
      header.addEventListener('click', toggleAccordion);
    });
  }

  function toggleAccordion() {
    const category = this.parentElement;
    const isCollapsed = category.classList.contains('collapsed');
    
    if(isCollapsed) {
      category.classList.remove('collapsed');
      this.querySelector('button').setAttribute('aria-expanded', 'true');
    } else {
      category.classList.add('collapsed');
      this.querySelector('button').setAttribute('aria-expanded', 'false');
    }
  }

  // 页面加载时初始化
  document.addEventListener('DOMContentLoaded', initAccordions);
  
  // Shopify主题编辑器可能需要这个
  if (typeof Shopify === 'object') {
    document.addEventListener('shopify:section:load', initAccordions);
  }
})();
</script>

{% schema %}
{
  "name": "可折叠网格列表",
  "settings": [
    {
      "type": "range",
      "id": "columns",
      "min": 1,
      "max": 4,
      "step": 1,
      "label": "每行显示数量",
      "default": 4
    },
    {
      "type": "range",
      "id": "gap",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "网格间距",
      "default": 16
    },
    {
      "type": "header",
      "content": "标题样式"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "标题字号",
      "default": 16
    },
    {
      "type": "select",
      "id": "title_weight",
      "label": "标题粗细",
      "options": [
        {
          "value": "normal",
          "label": "普通"
        },
        {
          "value": "bold",
          "label": "加粗"
        }
      ],
      "default": "bold"
    }
  ],
  "blocks": [
    {
      "type": "category",
      "name": "分类项",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "分类标题",
          "default": "分类名称"
        },
        {
          "type": "range",
          "id": "item_count",
          "min": 1,
          "max": 12,
          "step": 1,
          "label": "网格项数量",
          "default": 4,
          "info": "最多可添加12个网格项"
        },
        {
          "type": "header",
          "content": "网格项配置"
        },
        {
          "type": "header",
          "content": "网格项1"
        },
        {
          "type": "image_picker",
          "id": "image_1",
          "label": "图片1"
        },
        {
          "type": "text",
          "id": "title_1",
          "label": "标题1",
          "default": "项目1"
        },
        {
          "type": "richtext",
          "id": "text_1",
          "label": "文本1"
        },
        {
          "type": "header",
          "content": "网格项2"
        },
        {
          "type": "image_picker",
          "id": "image_2",
          "label": "图片2"
        },
        {
          "type": "text",
          "id": "title_2",
          "label": "标题2",
          "default": "项目2"
        },
        {
          "type": "richtext",
          "id": "text_2",
          "label": "文本2"
        },
        {
          "type": "header",
          "content": "网格项3"
        },
        {
          "type": "image_picker",
          "id": "image_3",
          "label": "图片3"
        },
        {
          "type": "text",
          "id": "title_3",
          "label": "标题3",
          "default": "项目3"
        },
        {
          "type": "richtext",
          "id": "text_3",
          "label": "文本3"
        },
        {
          "type": "header",
          "content": "网格项4"
        },
        {
          "type": "image_picker",
          "id": "image_4",
          "label": "图片4"
        },
        {
          "type": "text",
          "id": "title_4",
          "label": "标题4",
          "default": "项目4"
        },
        {
          "type": "richtext",
          "id": "text_4",
          "label": "文本4"
        },
        {
          "type": "header",
          "content": "网格项5"
        },
        {
          "type": "image_picker",
          "id": "image_5",
          "label": "图片5"
        },
        {
          "type": "text",
          "id": "title_5",
          "label": "标题5",
          "default": "项目5"
        },
        {
          "type": "richtext",
          "id": "text_5",
          "label": "文本5"
        },
        {
          "type": "header",
          "content": "网格项6"
        },
        {
          "type": "image_picker",
          "id": "image_6",
          "label": "图片6"
        },
        {
          "type": "text",
          "id": "title_6",
          "label": "标题6",
          "default": "项目6"
        },
        {
          "type": "richtext",
          "id": "text_6",
          "label": "文本6"
        },
        {
          "type": "header",
          "content": "网格项7"
        },
        {
          "type": "image_picker",
          "id": "image_7",
          "label": "图片7"
        },
        {
          "type": "text",
          "id": "title_7",
          "label": "标题7",
          "default": "项目7"
        },
        {
          "type": "richtext",
          "id": "text_7",
          "label": "文本7"
        },
        {
          "type": "header",
          "content": "网格项8"
        },
        {
          "type": "image_picker",
          "id": "image_8",
          "label": "图片8"
        },
        {
          "type": "text",
          "id": "title_8",
          "label": "标题8",
          "default": "项目8"
        },
        {
          "type": "richtext",
          "id": "text_8",
          "label": "文本8"
        },
        {
          "type": "header",
          "content": "网格项9"
        },
        {
          "type": "image_picker",
          "id": "image_9",
          "label": "图片9"
        },
        {
          "type": "text",
          "id": "title_9",
          "label": "标题9",
          "default": "项目9"
        },
        {
          "type": "richtext",
          "id": "text_9",
          "label": "文本9"
        },
        {
          "type": "header",
          "content": "网格项10"
        },
        {
          "type": "image_picker",
          "id": "image_10",
          "label": "图片10"
        },
        {
          "type": "text",
          "id": "title_10",
          "label": "标题10",
          "default": "项目10"
        },
        {
          "type": "richtext",
          "id": "text_10",
          "label": "文本10"
        },
        {
          "type": "header",
          "content": "网格项11"
        },
        {
          "type": "image_picker",
          "id": "image_11",
          "label": "图片11"
        },
        {
          "type": "text",
          "id": "title_11",
          "label": "标题11",
          "default": "项目11"
        },
        {
          "type": "richtext",
          "id": "text_11",
          "label": "文本11"
        },
        {
          "type": "header",
          "content": "网格项12"
        },
        {
          "type": "image_picker",
          "id": "image_12",
          "label": "图片12"
        },
        {
          "type": "text",
          "id": "title_12",
          "label": "标题12",
          "default": "项目12"
        },
        {
          "type": "richtext",
          "id": "text_12",
          "label": "文本12"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "可折叠网格列表",
      "blocks": [
        {
          "type": "category",
          "settings": {
            "title": "示例分类",
            "item_count": 4
          }
        }
      ]
    }
  ]
}
{% endschema %}
